const EXCERPTS = {
    congress: "[...] This is a dangerous path. I believe our country needs excellent \njudges. Time and again--in the Acting President pro tempore's State of \nNew Hampshire, in my State of Illinois--you go to people who are \nsitting on the bench in a State court or in private practice and ask \nthem if they would consider serving their Nation on the Federal court, \nand they know it is a big decision: whether they are going to change a \ncareer. But they know just as well that by submitting their name to the \nprocess, they are subjecting themselves to criticism, which many people \njust do not care to withstand.\n  In this case, the criticism against Caitlin Halligan is baseless. If \njudicial nominees cannot be considered fairly by the Senate on their \nown merits, good lawyers are simply going to stop putting their name \ninto the process for consideration and our country will suffer as a \nresult.\n  We should give Ms. Halligan an up-or-down vote on her merits. On that \nstandard, she should clearly be confirmed.\nHAZARDOUS WASTE ELECTRONIC MANIFEST ESTABLISHMENT ACT\n\n  The bill (S. 710) to amend the Solid Waste Disposal Act to direct the \nAdministrator of the Environmental Protection Agency to establish a \nhazardous waste electronic manifest system was ordered to be engrossed \nfor a third reading, was read the third time, and passed, as follows:\n\n                                 S. 710\n\n       Be it enacted by the Senate and House of Representatives of \n     the United States of America in Congress assembled,\n\n     SECTION 1. SHORT TITLE.\n\n       This Act may be cited as the ``Hazardous Waste Electronic \n     Manifest Establishment Act''.\n\n     SEC. 2. HAZARDOUS WASTE ELECTRONIC MANIFEST SYSTEM.\n\n       (a) In General.--Subtitle C of the Solid Waste Disposal Act \n     (42 U.S.C. 6921 et seq.) is amended by adding at the end the \n     following:\n\n     ``SEC. 3024. HAZARDOUS WASTE ELECTRONIC MANIFEST SYSTEM.\n\n       ``(a) Definitions.--In this section:\n       ``(1) Board.--The term `Board' means the Hazardous Waste \n     Electronic Manifest System Advisory Board established under \n     subsection (f).\n       ``(2) Fund.--The term `Fund' means the Hazardous Waste \n     Electronic Manifest System Fund established by subsection \n     (d).\n       ``(3) Person.--The term `person' includes an individual, \n     corporation (including a Government corporation), company, \n     association, firm, partnership, society, joint stock company, \n     trust, municipality, commission, Federal agency, State, [...]",
    goethe: "Sehnsucht (1770)\nDies wird die letzte Trän' nicht sein,\nDie glühend Herz aufquillet,\nDas mit unsäglich neuer Pein\nSich schmerzvermehrend stillet.\nOh! laß doch immer hier und dort\nMich ewig Liebe fühlen,\nUnd möcht' der Schmerz auch also fort\nDurch Nerv' und Ader wühlen.\nKönnt' ich doch ausgefüllt einmal\nVon dir, o Ew'ger, werden -\nAch, diese lange, tiefe Qual,\nWie dauert sie auf Erden!\n\n\nZum Divan.\n\n\nWer sich selbst und Andre kennt,\nWird auch hier erkennen:\nOrient und Occident\nSind nicht mehr zu trennen. \nSinnig zwischen beiden Welten\nSich zu wiegen lass' ich gelten;\nAlso zwischen Ost und Westen\nSich bewegen, sei's zum Besten!\n\n\n\n\nRegenbogen\nüber den Hügeln einer anmutigen Landschaft [...]",
    southPark: "[...] Dude, what are you talking about, that was awesome! Dude, she's a chick! Come on, nobody's going to notice.\nWhat about herhuge freakin' hooters, huh? She's the best chance we have, i say she's in.\nMe too.\nMe too.\nOh, this is a democratic boy band, is it? All right fine, she's in until she screws up.\nYeah! Okay, you guys all ready to rehearse? It's 6:00 in the morning, do we have to rehearse this early? We have to rehearse all that we can.\nNow check this out, my mom made us costumes.\nCostumes? Yeah, this one's yours stan.\nThis one is kyle's.\nThis one will cover-Up wendy's hooters.\nHey cartman, how come your costume has, like, nose-Rings and facial hair? 'Cause i'm like, you know, the tough one.\nEvery boy band has to have the one member that's, you know, is tough.\nI want to be the tough one.\nKyle, you are the sweet one, will you please just cooperate and not- I wanna be thetoughone.\nYou can't be the tough one because you'rejewish! Jews are tough! Since when? Since abraham, fatass! All right, fine, here.\nJesus christ, i wonder if every boy band had to go through this.\nHey cartman, what does \"fingerbang\" mean anyways? I heard it on hbo, it means like, you know, When you pretend to use your finger like a gun or something.\nMrlp-Mrhh-Mrr-Mrlp! Kenny says that's not what it means. [...]",
    sherlock: "[...] \"That is so,\" said Colonel Emsworth.\n\"I foresaw this situation,\" I explained, \"and I have brought with me\na friend whose discretion may absolutely be trusted. I was able once\nto do him a professional service, and he is ready to advise as a\nfriend rather than as a specialist. His name is Sir James Saunders.\"\nThe prospect of an interview with Lord Roberts would not have excited\ngreater wonder and pleasure in a raw subaltern than was now reflected\nupon the face of Mr. Kent.\n\"I shall indeed be proud,\" he murmured.\n\"Then I will ask Sir James to step this way. He is at present in the\ncarriage outside the door. Meanwhile, Colonel Emsworth, we may\nperhaps assemble in your study, where I could give the necessary\nexplanations.\"\nAnd here it is that I miss my Watson. By cunning questions and\nejaculations of wonder he could elevate my simple art, which is but\nsystematized common sense, into a prodigy. When I tell my own story I\nhave no such aid. And yet I will give my process of thought even as I\ngave it to my small audience, which included Godfrey's mother in the\nstudy of Colonel Emsworth. [...]",
    wiki: "[...] There were also lingering concerns over the fact that the Certificate of Approval for the site had not been revoked. The county has not ruled out using the site for other waste management purposes, such as for recycling.\nOn May 26, 2010 the operating certificate was revoked by the province, protecting the property from ever being used for waste disposal again.\nThe community effort to stop the Site 41 landfill is cited as a standard by which opposition was mounted against the Highland Companies mega quarry north of Toronto.\n\n\nThe Kunjra (pronounced as Kunjrda or Kunjda ) are a Muslim community found in North India, and Central India.\nThe Kunjra are a community associated with green grocing, who sell mainly vegetable and fruits. The name of the community is derived from Arabic word kunj, which means a group of warrior . The now prefer to call themselves kunjas, and claim their migration from the Kunja mountains in Arabia. According to Gazetteet Punjab, they are known to be the descendants of Raja Kunjpal, the Raja of Kunjah town lies in the Gujrat district of Punjab province, that is now in Pakistan.\nThere are social divisions within the community, such as Jaunpuria, Mirzapuria and Purbia. In Awadh, the Rayeen Kunjra now form a distinct endogamous group. Unlike other Kunjra groups, the Rayeen are largely a community of peasant cultivators. The Kunjra are strictly endogamous.The Rayeen is a Sunni Muslim community who were originally petty landowners or gardeners[1][2][3] and are present mainly in Western part of the state of Uttar Pradesh in India. Many have associated with the Arain community of Punjab.[4][5]They are said to get their name from Rayeen mountains, which are said to exist somewhere in Arabia. They speak Urdu, Hindi, In fact the Rayeen community of UP West like Bareilly and Pilibhit are the most educated, [...]"
};
let FLIP_DATASET_BUTTON = $('#flip-dataset-card-button');

window.onContentReadyCallbacks.push(function () {
    FLIP_DATASET_BUTTON = $('#flip-dataset-card-button');
    $('#dataset-card').flip({
      trigger: 'manual'
    });
    onDatasetChanged();
});

function flipDatasetCard() {
    const showExcerpt = FLIP_DATASET_BUTTON.val() == 'showExcerpt';
    const newText = showExcerpt ? 'Show Results' : 'Show Excerpt';
    const newVal = showExcerpt ? 'showResults' : 'showExcerpt';
    $('#dataset-card').flip(showExcerpt);
    FLIP_DATASET_BUTTON.html(newText).val(newVal);
}

function onDatasetChanged() {
    const datasetName = $('#dataset-dropdown').find('.dropdown-toggle').val();

    // Update the dataset excerpt
    $('#dataset-excerpt').html(EXCERPTS[datasetName]).scrollTop(0);

    // Plot the dataset
    $.getJSON(`assets/posts/char-lm/data/${datasetName}/model.trainstate.json`)
        .then(trainstate => {
            plotDatasetLog(PostUtil.getPreprocessedLog(trainstate.log));
        })
        .catch(console.error);
}

function getEquidistantPoints(data, numPoints) {
    if (data.length <= numPoints) return data;

    // Get the range
    const {minX, maxX} = data.reduce((reduced, point) => {
        if (point.x < reduced.minX) reduced.minX = point.x;
        if (point.x > reduced.maxX) reduced.maxX = point.x;
        return reduced;
    }, {minX: data[0].x, maxX: data[0].x});

    // Sample the points
    let points = [];
    const stepSize = (maxX - minX) / (numPoints - 1);
    data.sort((a, b) => a.x - b.x).forEach(point => {
        if (point.x >= minX + points.length * stepSize - Math.pow(10, -8)) {
            points.push(point);
        }
    });
    return points;
}

function getData(log, xKey, yKey) {
    let dataMap = PostUtil.replaceClosestKeys(log[yKey], log[xKey]);
    let data = [];
    dataMap.forEach((value, key) => {
        data.push({x: key, y: value});
    });
    return data;
}

function plotDatasetLog(log) {
    let lossesTrain = getData(log, 'epochs', 'lossesTrain')
        .filter(point => {
            // Ignore and filter outliers completely
            return !(point.y > 30 || point.y < 0.01);
        });
    let lossesValid = getData(log, 'epochs', 'lossesValid')
        .filter(point => {
            // Ignore and filter outliers completely
            return !(point.y > 30 || point.y < 0.01);
        });

    const datasets = [{
        label: 'Training',
        data: getEquidistantPoints(lossesTrain, 30),
        borderColor: PostUtil.CHART_COLORS_BLUE[1],
        backgroundColor: PostUtil.CHART_COLORS_BLUE[1]
    }, {
        label: 'Validation',
        data: getEquidistantPoints(lossesValid, 30),
        borderColor: PostUtil.CHART_COLORS_BLUE[4],
        backgroundColor: PostUtil.CHART_COLORS_BLUE[4]
    }];

    PostUtil.clearChart('dataset-chart');
    const chartParams = {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            scales: {
                xAxes: [{
                    type: 'linear',
                    position: 'bottom',
                    scaleLabel: {
                        display: true,
                        labelString: 'Epoch'
                    }
                }],
                yAxes: [{
                    type: 'logarithmic',
                    ticks: {
                        callback: value => value.toFixed(2)
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'Perplexity'
                    }
                }]
            }
        }
    };
    new Chart('dataset-chart', chartParams);
}